<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memuat...</title>
    <meta name="theme-color" content="#96e6a1"/>
    <link rel="manifest" href="manifest.json">
    
    <meta name="description" content="Halaman Bio Link Pribadi yang dinamis dengan fitur penjadwal tugas yang terhubung ke cloud.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root {
            --bg-gradient-start: #d4fc79; --bg-gradient-end: #96e6a1;
            --container-bg: rgba(255, 255, 255, 0.65); --primary-text: #1c1e21;
            --secondary-text: #555; --link-bg: rgba(255, 255, 255, 0.7);
            --link-hover-bg: rgba(255, 255, 255, 1); --shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            --border-color: rgba(200, 200, 200, 0.5); --border-radius: 16px;
            --blur-intensity: 10px; --accent-color: #96e6a1;
            --danger-color: #ff5b5b;
        }
        [data-theme='dark'] {
            --bg-gradient-start: #0f2027; --bg-gradient-end: #203a43;
            --container-bg: rgba(20, 20, 20, 0.5); --primary-text: #f0f2f5;
            --secondary-text: #a0a0a0; --link-bg: rgba(40, 40, 40, 0.6);
            --link-hover-bg: rgba(50, 50, 50, 0.8); --shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            --border-color: rgba(255, 255, 255, 0.15);
        }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(-45deg, var(--bg-gradient-start), var(--bg-gradient-end), #f8ffae, #fdeb71); background-size: 400% 400%; animation: gradient-animation 15s ease infinite; color: var(--primary-text); display: flex; justify-content: center; align-items: center; padding: 20px; min-height: 100vh; transition: background 0.5s ease; }
        .hidden { display: none !important; }
        .container { max-width: 680px; width: 100%; text-align: center; background: var(--container-bg); backdrop-filter: blur(var(--blur-intensity)); -webkit-backdrop-filter: blur(var(--blur-intensity)); border-radius: var(--border-radius); padding: 30px 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); transition: background 0.3s ease; position: relative; }
        .header-top-row { display: flex; justify-content: flex-end; align-items: center; position: absolute; top: 20px; right: 20px; z-index: 10; gap: 15px; }
        .profile-section { margin-bottom: 20px; margin-top: 30px; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); box-shadow: var(--shadow); }
        .profile-name { font-size: 2rem; font-weight: 700; margin: 15px 0 5px; }
        .profile-description { font-size: 1rem; color: var(--secondary-text); max-width: 90%; margin: 0 auto 20px auto; }
        .clock-container { background-color: var(--link-bg); padding: 10px 15px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--border-color); }
        .clock-time { font-size: 1.8rem; font-weight: 600; letter-spacing: 2px; }
        .clock-date { font-size: 0.9rem; color: var(--secondary-text); }
        .theme-switch { display: inline-block; height: 28px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: rgba(0,0,0,0.2); position: absolute; inset: 0; cursor: pointer; transition: .4s; border-radius: 28px; }
        .slider:before { background-color: #fff; position: absolute; content: ""; height: 20px; width: 20px; bottom: 4px; left: 4px; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .search-wrapper { margin-bottom: 20px; }
        #search-input { width: 100%; padding: 12px 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--link-bg); color: var(--primary-text); font-size: 1rem; }
        .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { flex: 1; padding: 10px; background-color: transparent; border: none; border-bottom: 3px solid transparent; color: var(--secondary-text); font-size: 1rem; font-weight: 600; cursor: pointer; transition: color 0.3s, border-color 0.3s; }
        .tab-button.active { color: var(--primary-text); border-bottom-color: var(--accent-color); }
        .category-group { margin-bottom: 25px; }
        .category-title { font-size: 1.2rem; font-weight: 600; text-align: left; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid var(--border-color); }
        .link-item, .media-item-link { background-color: var(--link-bg); color: var(--primary-text); padding: 15px 20px; border-radius: var(--border-radius); text-decoration: none; font-weight: 600; font-size: 1rem; transition: background-color 0.2s, transform 0.2s; border: 1px solid var(--border-color); display: flex; margin-bottom: 15px; align-items: center; }
        .link-item:hover, .media-item-link:hover { background-color: var(--link-hover-bg); transform: scale(1.02); }
        .media-item-link .thumbnail { width: 80px; height: 80px; flex-shrink: 0; border-radius: 10px; object-fit: cover; margin-right: 15px; }
        .media-item-link .media-title { font-weight: 600; }
        .copyright-footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); color: var(--secondary-text); font-size: 0.9rem; }
        .no-results-message { color: var(--secondary-text); padding: 20px; text-align: center; }
        .notification-bell { position: relative; cursor: pointer; font-size: 1.5rem; color: var(--primary-text); }
        .notif-badge { position: absolute; top: -5px; right: -8px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; font-weight: bold; display: flex; justify-content: center; align-items: center; }
        .notif-dropdown { display: none; position: absolute; top: 40px; right: 0; background-color: var(--container-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); width: 300px; z-index: 20; padding: 10px; text-align: left; }
        .notif-dropdown h4 { margin: 0 0 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        .notif-item { font-size: 0.9rem; padding: 8px; border-radius: 8px; margin-bottom: 5px; }
        .notif-item strong { color: var(--danger-color); }
        .task-scheduler-container { text-align: left; }
        .task-input-form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .task-input-form > input { flex-grow: 1; padding: 12px 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--link-bg); color: var(--primary-text); font-size: 1rem; min-width: 150px; }
        .add-task-btn { padding: 12px 15px; border: none; background-color: var(--accent-color); color: var(--primary-text); border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .add-task-btn:disabled { background-color: var(--secondary-text); cursor: not-allowed; }
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; gap: 15px; background-color: var(--link-bg); padding: 12px 15px; border-radius: var(--border-radius); margin-bottom: 10px; border: 1px solid var(--border-color); }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; accent-color: var(--accent-color); cursor: pointer; }
        .task-item.completed .task-text, .task-item.completed .task-date { text-decoration: line-through; color: var(--secondary-text); }
        .task-details { flex-grow: 1; text-align: left; }
        .task-text { font-size: 0.95rem; }
        .task-date { font-size: 0.8rem; color: var(--secondary-text); }
        .task-item.overdue .task-date { color: var(--danger-color); font-weight: bold; }
        .delete-task-btn { background: none; border: none; color: var(--secondary-text); font-size: 1.1rem; cursor: pointer; transition: color 0.2s; padding: 5px; flex-shrink: 0; }
        .delete-task-btn:hover { color: var(--danger-color); }
        .socials-container { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .social-link { display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; background-color: #fff; border-radius: 50%; text-decoration: none; box-shadow: var(--shadow); transition: transform 0.2s ease; }
        .social-link:hover { transform: scale(1.1); }
        .social-link i { font-size: 1.5rem; transition: color 0.3s; }
        .social-link .fa-instagram { color: #C13584; }
        .social-link .fa-globe { color: #333; }
        [data-theme='dark'] .social-link { background-color: rgba(255, 255, 255, 0.1); }
        [data-theme='dark'] .social-link i { color: #fff; }
        #lock-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--container-bg); backdrop-filter: blur(var(--blur-intensity)); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .lock-box { background-color: var(--link-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border-color); width: 90%; max-width: 400px; }
        #lock-screen-pic { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); margin-bottom: 15px; }
        .lock-box h2 { font-size: 1.7rem; color: var(--primary-text); margin: 0 0 10px; }
        .lock-box p { font-size: 1rem; color: var(--secondary-text); max-width: 90%; margin: 0 auto 20px auto; line-height: 1.5; }
        #security-key-input { width: 100%; padding: 12px 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--link-hover-bg); color: var(--primary-text); font-size: 1rem; margin-bottom: 20px; }
        #unlock-button { width: 100%; padding: 12px 15px; border: none; background-color: var(--accent-color); color: var(--primary-text); border-radius: var(--border-radius); font-weight: 600; cursor: pointer; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body>
    <div id="lock-screen">
        <div class="lock-box">
            <img id="lock-screen-pic" src="" alt="Foto Profil">
            <h2 id="lock-screen-name"></h2>
            <p id="lock-screen-message"></p>
            <form id="lock-form">
                <input type="password" id="security-key-input" placeholder="Masukkan kunci..." required>
                <button type="submit" id="unlock-button">Buka</button>
            </form>
        </div>
    </div>

    <div class="container hidden">
        <div class="header-top-row">
            <div class="notification-bell" id="notification-bell">
                <i class="fas fa-bell"></i>
                <span class="notif-badge hidden" id="notif-badge">0</span>
                <div class="notif-dropdown" id="notif-dropdown">
                    <h4>Tugas Terlewat</h4>
                    <div id="notif-list"></div>
                </div>
            </div>
            <label class="theme-switch" for="theme-toggle">
                <input type="checkbox" id="theme-toggle" />
                <div class="slider round"></div>
            </label>
        </div>
        <header id="profile-section" class="profile-section"></header>
        <div class="search-wrapper">
            <input type="text" id="search-input" placeholder="Cari di semua konten...">
        </div>
        <nav class="tabs-nav">
            <button class="tab-button active" data-tab="links">Tautan</button>
            <button class="tab-button" data-tab="media">Media</button>
            <button class="tab-button" data-tab="scheduler">To-Do List</button>
        </nav>
        <main id="content-area"></main>
        <footer id="socials-container" class="socials-container"></footer>
        <div class="copyright-footer">© Luthfi Kurnia 2025</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
    const SECURITY_KEY = 'Herminapadang31'; 

    const firebaseConfig = {
      apiKey: "PASTE_API_KEY_ANDA_DI_SINI",
      authDomain: "PASTE_AUTH_DOMAIN_ANDA_DI_SINI",
      projectId: "PASTE_PROJECT_ID_ANDA_DI_SINI",
      storageBucket: "PASTE_STORAGE_BUCKET_ANDA_DI_SINI",
      messagingSenderId: "PASTE_MESSAGING_SENDER_ID_ANDA_DI_SINI",
      appId: "PASTE_APP_ID_ANDA_DI_SINI"
    };

    let db, tasksCollection;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        tasksCollection = db.collection("tasks");
    } catch (e) {
        console.error("Firebase GAGAL dimuat. Periksa `firebaseConfig` Anda.", e);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DEKLARASI DATA & ELEMEN ---
        const DATA = {
            profile: { 
                pageTitle: 'Bio Link Luthfi Kurnia',
                name: 'Luthfi Kurnia', 
                description: 'Selamat datang di pusat informasi dan layanan digital RS Hermina Padang. Temukan semua yang Anda butuhkan di sini.', 
                photoURL: 'https://images.unsplash.com/photo-1751766689803-1ffab3754631?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwcm9maWxlLXBhZ2V8MXx8fGVufDB8fHx8fA%3D%3D' 
            },
            links: [
                { category: 'Aplikasi Hermina', text: 'WEB Hermina', url: 'https://www.herminahospitals.com/en/branch/hermina-padang' },
                { category: 'Aplikasi Hermina', text: 'VClaim BPJS', url: 'https://vclaim.bpjs-kesehatan.go.id/VClaim/Penjaminan' },
                { category: 'Aplikasi Hermina', text: 'Hinai WEB', url: 'https://simrs.herminahospitals.com/live/login.html' },
                { category: 'Aplikasi Hermina', text: 'SIPP BPJS Kesehatan', url: 'https://sipp.bpjs-kesehatan.go.id/sipp/#/access/signin' },
                { category: 'Aplikasi Hermina', text: 'Hermina SuperAPP', url: 'https://superapps.herminahospitals.com/' },
                { category: 'Aplikasi Hermina', text: 'Afya Better Test', url: '#' },
                { category: 'Aplikasi Hermina', text: 'WhatsApp WEB', url: 'https://web.whatsapp.com/' },
                { category: 'Dokumen-Dokumen', text: 'Jadwal Dokter', url: '#' },
                { category: 'Dokumen-Dokumen', text: 'Master Tarif', url: 'https://drive.google.com/file/d/1RyG2IrS3xxzLPnB0Gtx2LFp1A-dVZTmx/view?usp=sharing' },
                { category: 'Dokumen-Dokumen', text: 'Estimasi Biaya TopUp', url: 'https://drive.google.com/file/d/1BJi5Jixp1azPwwD_1leyQ3eFwDQhQV8L/view' },
                { category: 'Dokumen-Dokumen', text: 'PKS Asuransi', url: '#' },
                { category: 'Dashboard Kamar RWI', text: 'Dashboard Kamar Lantai 4', url: 'https://docs.google.com/spreadsheets/d/1doB7A3bFR6AU3hq4yFgPUne3jBUnaaTN33om0xqXXt8/edit?gid=0#gid=0' },
                { category: 'Dashboard Kamar RWI', text: 'Dashboard Kamar Lantai 5', url: 'https://docs.google.com/spreadsheets/d/1kwyrwe_Bc-duSjlPiwdpnjVIchKSSBcJqILyzp-hDdE/edit?usp=drive_link' },
                { category: 'Dashboard Kamar RWI', text: 'Dashboard Kamar Lantai 6', url: 'https://docs.google.com/spreadsheets/d/1Tz_0oimiY1pnltzFJ0HuHQHoJ0KU5-ZuvHU58lRvK88/edit?usp=drive_link' },
                { category: 'Dashboard Kamar RWI', text: 'Dashboard Kamar Lantai 7', url: '#' },
                { category: 'Dashboard Kamar RWI', text: 'Dashboard Kamar Intensif', url: 'https://docs.google.com/spreadsheets/d/1iIVbS5tdT38S_5eXIzPxoh3bt9Pqwu67WjYv3PDaYhM/edit?gid=424558827#gid=424558827' },
                { category: 'Laporan-Laporan', text: 'Lain-lain 1', url: '#' },
                { category: 'Website Asuransi', text: 'Lain-lain 11', url: '#' },
                { category: 'Lain-lain', text: 'Lain-lain 12', url: '#' }
            ],
            media: [ 
                { category: 'Layanan Padma', title: 'Paket Melahirkan', thumbnailURL: 'https://images.unsplash.com/photo-1751767762107-c5f6da070638?q=80&w=711&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', url: '#'},
                { category: 'Layanan Padma', title: 'Brosur Layanan Padma', thumbnailURL: 'https://images.unsplash.com/photo-1751767447021-0e7871027aea?q=80&w=1123&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', url: '#' },
                { category: 'Layanan Padma', title: 'Paket Klinik Tumbuh Kembang', thumbnailURL: 'https://images.unsplash.com/photo-1751767761404-91becfbf9060?q=80&w=710&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', url: '#'},
            ],
            socials: [ 
                { platform: 'website', url: '#' }, 
                { platform: 'instagram', url: '#' } 
            ]
        };
        const socialIconMap = { 'instagram': 'fa-brands fa-instagram', 'website': 'fa-solid fa-globe' };
        
        const mainContainer = document.querySelector('.container');
        const lockScreen = document.getElementById('lock-screen');
        const lockForm = document.getElementById('lock-form');
        const keyInput = document.getElementById('security-key-input');
        const profileSection = document.getElementById('profile-section');
        const contentArea = document.getElementById('content-area');
        const socialsContainer = document.getElementById('socials-container');
        const searchInput = document.getElementById('search-input');
        const tabsNav = document.querySelector('.tabs-nav');
        let allTasks = [];
        let isAppInitialized = false;

        // --- 2. DEKLARASI SEMUA FUNGSI ---
        
        function initializeLockScreen() {
            document.getElementById('lock-screen-pic').src = DATA.profile.photoURL;
            document.getElementById('lock-screen-name').textContent = DATA.profile.name;
            document.getElementById('lock-screen-message').textContent = "Terima Kasih telah mengunjungi Website Saya, untuk mendapatkan informasi di dalamnya, Silahkan Masukan Kata Sandinya :)";
        }

        function unlockWebsite() {
            lockScreen.classList.add('hidden');
            mainContainer.classList.remove('hidden');
            if (!isAppInitialized) {
                runApp();
                isAppInitialized = true;
            }
        }
        
        function renderStaticContent() {
            document.title = DATA.profile.pageTitle;
            profileSection.innerHTML = `<img src="${DATA.profile.photoURL}" alt="Foto Profil" class="profile-pic"><h1 class="profile-name">${DATA.profile.name}</h1><p class="profile-description">${DATA.profile.description}</p><div class="clock-container"><div class="clock-time" id="clock-time"></div><div class="clock-date" id="clock-date"></div></div>`;
            socialsContainer.innerHTML = DATA.socials.map(s => `<a href="${s.url}" target="_blank" class="social-link"><i class="${socialIconMap[s.platform] || 'fa-solid fa-link'}"></i></a>`).join('');
            const timeEl = document.getElementById('clock-time'), dateEl = document.getElementById('clock-date');
            const updateClock = () => {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Jakarta' }).replace(/\./g, ':');
                dateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jakarta' });
            };
            updateClock(); setInterval(updateClock, 1000);
        }
        
        function generateSectionHTML(items, type) {
            if (!items || items.length === 0) return '';
            const grouped = items.reduce((acc, item) => {
                const category = item.category || 'Lain-lain';
                if (!acc[category]) acc[category] = [];
                acc[category].push(item); return acc;
            }, {});
            let html = '';
            for (const category in grouped) {
                html += `<div class="category-group"><h2 class="category-title">${category}</h2>`;
                if (type === 'links') {
                    html += grouped[category].map(item => `<a href="${item.url}" target="_blank" class="link-item">${item.text}</a>`).join('');
                } else if (type === 'media') {
                    html += grouped[category].map(item => `<a href="${item.url}" target="_blank" class="media-item-link"><img src="${item.thumbnailURL}" alt="${item.title}" class="thumbnail" loading="lazy"><div class="media-title">${item.title}</div></a>`).join('');
                }
                html += `</div>`;
            }
            return html;
        }

        async function renderDynamicContent() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const activeTab = document.querySelector('.tab-button.active').dataset.tab;
            searchInput.parentElement.style.display = (activeTab === 'scheduler') ? 'none' : 'block';
            if (activeTab === 'scheduler') { await renderScheduler(); return; }
            let htmlToRender = '';
            if (searchTerm) {
                const filteredLinks = DATA.links.filter(item => item.text.toLowerCase().includes(searchTerm));
                const filteredMedia = DATA.media.filter(item => item.title.toLowerCase().includes(searchTerm));
                if (filteredLinks.length > 0) htmlToRender += generateSectionHTML(filteredLinks, 'links');
                if (filteredMedia.length > 0) htmlToRender += generateSectionHTML(filteredMedia, 'media');
            } else {
                const dataToRender = activeTab === 'links' ? DATA.links : DATA.media;
                htmlToRender = generateSectionHTML(dataToRender, activeTab);
            }
            contentArea.innerHTML = htmlToRender || '<p class="no-results-message">Tidak ada konten yang cocok.</p>';
        }

        async function fetchAllTasks() {
            if (!tasksCollection) return [];
            try {
                const snapshot = await tasksCollection.orderBy("dueDate", "desc").get();
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                tasks.sort((a, b) => (a.dueTime || "00:00").localeCompare(b.dueTime || "00:00"));
                allTasks = tasks;
                checkNotifications();
                return allTasks;
            } catch (error) { 
                console.error("Error fetching tasks:", error); 
                contentArea.innerHTML = '<p class="no-results-message">Gagal memuat tugas. Pastikan indeks `dueDate` (descending) ada di Firebase.</p>';
                return []; 
            }
        }

        function checkNotifications() {
            const now = new Date();
            const overdue = allTasks.filter(t => !t.completed && new Date(`${t.dueDate}T${t.dueTime}`) < now);
            const badge = document.getElementById('notif-badge'), list = document.getElementById('notif-list');
            list.innerHTML = '';
            if (overdue.length > 0) {
                badge.textContent = overdue.length;
                badge.classList.remove('hidden');
                overdue.forEach(t => { list.innerHTML += `<div class="notif-item"><strong>${t.text}</strong> - Terlewat.</div>`; });
            } else {
                badge.classList.add('hidden');
                list.innerHTML = '<p class="no-results-message">Tidak ada notifikasi.</p>';
            }
        }
        
        function getTodayString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function getCurrentTimeString() {
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        async function renderScheduler() {
            contentArea.innerHTML = `<div class="task-scheduler-container"><form id="task-form" class="task-input-form"><input type="text" id="new-task-input" placeholder="Tugas baru..." required><input type="date" id="task-due-date" required><input type="time" id="task-due-time" required><button type="submit" class="add-task-btn">Tambah</button></form><ul id="task-list" class="task-list"><li>Memuat...</li></ul></div>`;
            document.getElementById('task-due-date').value = getTodayString();
            document.getElementById('task-due-time').value = getCurrentTimeString();
            document.getElementById('task-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target, textInput = form.querySelector('#new-task-input'), dateInput = form.querySelector('#task-due-date'), timeInput = form.querySelector('#task-due-time'), submitBtn = form.querySelector('.add-task-btn');
                if (textInput.value.trim() && dateInput.value && timeInput.value) {
                    submitBtn.disabled = true; submitBtn.textContent = 'Menyimpan...';
                    await addTask({ text: textInput.value.trim(), dueDate: dateInput.value, dueTime: timeInput.value, completed: false, notified: false });
                    textInput.value = ''; submitBtn.disabled = false; submitBtn.textContent = 'Tambah';
                }
            });
            displayTasks(await fetchAllTasks());
        }
        
        function displayTasks(tasks) {
            const listEl = document.getElementById('task-list');
            if (!tasksCollection) { listEl.innerHTML = '<p class="no-results-message">Fitur To-Do List eror.</p>'; return; }
            if (!tasks || tasks.length === 0) { listEl.innerHTML = '<p class="no-results-message">Belum ada tugas.</p>'; return; }
            listEl.innerHTML = '';
            tasks.forEach(task => {
                const li = document.createElement('li'), dueDate = new Date(`${task.dueDate}T${task.dueTime || '00:00'}`);
                li.className = `task-item ${task.completed ? 'completed' : ''} ${!task.completed && dueDate < new Date() ? 'overdue' : ''}`;
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.checked = task.completed;
                checkbox.addEventListener('change', () => toggleTask(task.id, checkbox.checked));
                const details = document.createElement('div');
                details.className = 'task-details';
                const dateStr = dueDate.toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'});
                const timeStr = task.dueTime ? ` - ${task.dueTime}` : '';
                details.innerHTML = `<span class="task-text">${task.text}</span><div class="task-date">Batas: ${dateStr}${timeStr}</div>`;
                const delBtn = document.createElement('button');
                delBtn.className = 'delete-task-btn'; delBtn.innerHTML = '<i class="fas fa-trash-can"></i>';
                delBtn.addEventListener('click', () => deleteTask(task.id));
                li.append(checkbox, details, delBtn);
                listEl.appendChild(li);
            });
        }
        
        async function addTask(data) { try { await tasksCollection.add(data); await renderScheduler(); } catch (e) { console.error("Gagal menambah tugas:", e); } }
        async function toggleTask(id, completed) { try { await tasksCollection.doc(id).update({ completed }); allTasks.find(t => t.id === id).completed = completed; displayTasks(allTasks); checkNotifications(); } catch (e) { console.error("Gagal update tugas:", e); } }
        async function deleteTask(id) { if (confirm("Yakin ingin menghapus tugas ini?")) { try { await tasksCollection.doc(id).delete(); await renderScheduler(); } catch (e) { console.error("Gagal menghapus tugas:", e); } } }

        function requestNotificationPermission() { if (!("Notification" in window)) { console.log("Browser ini tidak mendukung notifikasi."); } else if (Notification.permission !== "denied") { Notification.requestPermission(); } }
        function checkTasksAndNotify() {
            if (!allTasks || Notification.permission !== "granted") return;
            const now = new Date();
            allTasks.forEach(task => {
                const dueDate = new Date(`${task.dueDate}T${task.dueTime}`);
                if (!task.completed && !task.notified && dueDate <= now) {
                    new Notification('Tugas Jatuh Tempo!', { body: task.text, icon: 'https://cdn-icons-png.flaticon.com/512/3239/3239952.png' });
                    tasksCollection.doc(task.id).update({ notified: true });
                }
            });
        }

        // --- 3. FUNGSI INISIALISASI UTAMA (Hanya berjalan sekali setelah login) ---
        function runApp() {
            if (isAppInitialized) return; // Pengaman agar tidak berjalan dua kali
            
            // Pasang semua event listener untuk aplikasi utama
            tabsNav.addEventListener('click', (e) => { 
                if (!e.target.matches('.tab-button')) return;
                tabsNav.querySelector('.active').classList.remove('active'); 
                e.target.classList.add('active'); 
                renderDynamicContent(); 
            });
            searchInput.addEventListener('input', renderDynamicContent);
            document.getElementById('notification-bell').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                document.getElementById('notif-dropdown').style.display = document.getElementById('notif-dropdown').style.display === 'block' ? 'none' : 'block'; 
            });
            window.addEventListener('click', (e) => { 
                if (!e.target.closest('.notification-bell')) document.getElementById('notif-dropdown').style.display = 'none'; 
            });
            const themeToggle = document.getElementById('theme-toggle');
            const setDocsTheme = (isDark) => { 
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light'); 
                localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
                themeToggle.checked = isDark; 
            };
            themeToggle.addEventListener('change', () => setDocsTheme(themeToggle.checked));
            setDocsTheme(localStorage.getItem('theme') === 'dark');

            // Jalankan fungsi-fungsi awal untuk menampilkan konten
            renderStaticContent();
            renderDynamicContent();
            requestNotificationPermission();
            setInterval(checkTasksAndNotify, 30000);

            isAppInitialized = true; // Tandai bahwa aplikasi sudah berjalan
        }
        
        // --- 4. TITIK MASUK SCRIPT ---
        
        // Siapkan layar kunci
        initializeLockScreen();
        keyInput.focus();

        // Pasang listener untuk form login
        lockForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (keyInput.value === SECURITY_KEY) {
                lockScreen.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                runApp(); // Jalankan aplikasi utama setelah kunci benar
            } else {
                const lockBox = document.querySelector('.lock-box');
                lockBox.classList.add('shake');
                setTimeout(() => lockBox.classList.remove('shake'), 820);
                keyInput.value = '';
            }
        });

        // Pendaftaran Service Worker untuk PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => { console.log('SW terdaftar: ', registration); })
                    .catch(error => { console.log('Pendaftaran SW gagal: ', error); });
            });
        }
    });
    </script>
</body>
</html>
